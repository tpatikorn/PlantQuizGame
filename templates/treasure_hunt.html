{% extends 'base.html' %}

{% block header %}
    <h1>{% block title %}Treasure Hunt: หาใบ {{ target_type }}{% endblock %}</h1>
{% endblock %}

{% block content %}
    <meta id="game_data"
          data-n_correct="{{ n_correct }}"
          data-n_col="{{ n_col }}"
          data-n_pics="{{ n_pics }}"
    >
    <link rel="stylesheet" href="{{ url_for("static", filename="games.css") }}">
    <script type="text/javascript" src="{{ url_for("static", filename="util.js") }}"></script>

    <script type="text/javascript">
        let scores = {correct: 0, incorrect: 0};
        let playing = true;
        let timer;
        let start_time;
        $(function () {
            $({{ all_img_src|safe }}).preload();

            const n_col = get_game_data("n_col", parseInt);
            const n_row = Math.ceil(get_game_data("n_pics", parseInt) / n_col);
            const img_width = 100;
            const td_width = img_width + 6;
            $("#treasure_map").css("height", n_row * td_width + "px").css("width", n_col * td_width + "px");
            $(".game_column").css("width", td_width + "px").css("height", td_width + "px");
            $(".game_img").css("width", img_width + "px").css("height", img_width + "px").hide();

            $('#start').on('click', function () {
                alert("เริ่ม!")
                $("#start").prop("disabled", true).removeClass("btn-primary").add("btn-secondary");
                $(".game_td_img").css("border", "transparent");
                $(".game_img").show();
                start_time = Date.now();

                timer = setInterval(function () {
                    $("#time_lapse").html(time_elapse_text())
                }, 5);
            });
            $('.game_img').on('click', function () {
                if (!playing) {
                    return;
                }
                if (!$(this).data("selected")) {
                    const correctness = $(this).data("correct");
                    if (correctness === 1) {
                        $(this).css("border", "2px solid green");
                        scores.correct += 1
                    } else {
                        $(this).css("border", "2px solid red");
                        scores.incorrect += 1
                    }
                    $(this).data("selected", true);
                    $("#correct").html(scores.correct);
                    $("#incorrect").html(scores.incorrect);
                    if (scores.correct === $("#game_data").data("n_correct")) {
                        playing = false;
                        clearInterval(timer);
                        $("#time_lapse").html(time_elapse_text());
                        let modal = new bootstrap.Modal('#result_modal');
                        modal.show();
                        $("#modal_body").html(`ในที่สุดก็เลือกครบ!<br>
                        ตอบถูก ${scores.correct} ภาพ<br>
                        ตอบผิด ${scores.incorrect} ภาพ<br>
                        ใช้เวลาไป ${time_elapse_text()}`);
                    }
                }
            });
        });

    </script>
    <div id="result_modal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="modal_body" style="text-align: center">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quiz" class="main_game">
        <input type="button" id="start" value="start" class="btn btn-primary"> <br>
        <span for="correct" class="badge bg-success">#correct
        <span id="correct" class="badge bg-light text-dark">0</span></span>
        <span for="incorrect" class="badge bg-danger">#incorrect
        <span id="incorrect" class="badge bg-light text-dark">0</span></span><br>
        <label for="time_lapse">เวลาที่ใช้: </label>
        <span id="time_lapse">00 นาที 00.000 วินาที</span>
        <div id="treasure_map" class="main_game">
            {% for i in range(0, img|length) %}
                {% if i % n_col == 0 %}
                    <div class="game_row">
                {% endif %}
            <row id="{{ img[i].id }}" class="game_column">
                <img src="images/{{ img[i].id }}" class="game_img" alt="{{ img[i].filename }}"
                     data-correct="{% if ans[i] %}1{% else %}0{% endif %}" data-selected="false"/>
            </row>
            {% if (i + 1) % n_col == 0 or i == img|length %}
                </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

{% endblock %}